{% extends 'attendance/base.html' %}
{% block title %}Dashboard - LPU Campus{% endblock %}

{% block content %}
<div class="page-header">
    <h4 class="mb-0 fw-bold">
        <i class="bi bi-speedometer2 me-2" style="color:#8B1A1A;"></i>
        Welcome, {{ request.user.get_full_name|default:request.user.username }}!
    </h4>
    <small class="text-muted">
        {% if role == 'faculty' %}Faculty Portal — Make-Up Class Management{% else %}Student Portal — Attendance Tracker{% endif %}
    </small>
</div>

{% if role == 'faculty' %}
<!-- ===== FACULTY DASHBOARD ===== -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #8B1A1A, #C0392B);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_classes }}</div>
                    <div class="stat-label">Total Make-Up Classes</div>
                </div>
                <i class="bi bi-calendar-week stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #1a6e3c, #27AE60);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ active_codes.count }}</div>
                    <div class="stat-label">Active Remedial Codes</div>
                </div>
                <i class="bi bi-key stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #1a4a8e, #2980B9);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="totalStudents">—</div>
                    <div class="stat-label">Quick Actions</div>
                </div>
                <i class="bi bi-lightning stat-icon"></i>
            </div>
            <div class="mt-2">
                <a href="{% url 'schedule_class' %}" class="btn btn-sm btn-light fw-semibold">
                    <i class="bi bi-plus-circle me-1"></i>Schedule Class
                </a>
            </div>
        </div>
    </div>
</div>

{% if active_codes %}
<div class="card mb-4">
    <div class="card-header-lpu">
        <i class="bi bi-key-fill me-2"></i>Active Remedial Codes Right Now
    </div>
    <div class="card-body">
        {% for code in active_codes %}
        <div class="d-flex align-items-center justify-content-between p-3 mb-2 rounded" style="background:#fff8f0; border: 2px dashed #F39C12;">
            <div>
                <div class="remedial-code-box d-inline-block" style="font-size:1.8rem; padding: 0.5rem 1.5rem;">
                    {{ code.code }}
                </div>
                <div class="ms-3 d-inline-block">
                    <strong>{{ code.makeup_class.subject }}</strong><br>
                    <small class="text-muted">Expires: {{ code.expires_at|date:"d M Y, h:i A" }}</small>
                </div>
            </div>
            <a href="{% url 'class_detail' code.makeup_class.pk %}" class="btn btn-sm btn-lpu btn-primary">
                <i class="bi bi-eye me-1"></i>View
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header-lpu d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2"></i>Recent Make-Up Classes</span>
        <a href="{% url 'faculty_classes' %}" class="btn btn-sm btn-light">View All</a>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-lpu">
                <tr><th>Subject</th><th>Date</th><th>Time</th><th>Venue</th><th>Status</th><th>Attendance</th><th></th></tr>
            </thead>
            <tbody>
                {% for cls in classes %}
                <tr>
                    <td><strong>{{ cls.subject }}</strong>{% if cls.topic %}<br><small class="text-muted">{{ cls.topic }}</small>{% endif %}</td>
                    <td>{{ cls.date|date:"d M Y" }}</td>
                    <td>{{ cls.start_time|time:"h:i A" }} - {{ cls.end_time|time:"h:i A" }}</td>
                    <td>{{ cls.venue }}</td>
                    <td><span class="badge badge-{{ cls.status }} text-white">{{ cls.get_status_display }}</span></td>
                    <td><span class="badge bg-secondary">{{ cls.total_attendance }} students</span></td>
                    <td><a href="{% url 'class_detail' cls.pk %}" class="btn btn-sm btn-outline-secondary">Manage</a></td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center text-muted py-4">No make-up classes yet. <a href="{% url 'schedule_class' %}">Schedule one now!</a></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}
<!-- ===== STUDENT DASHBOARD ===== -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #8B1A1A, #C0392B);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_attended }}</div>
                    <div class="stat-label">Make-Up Classes Attended</div>
                </div>
                <i class="bi bi-patch-check stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #1a6e3c, #27AE60);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value">
                        <i class="bi bi-qr-code-scan" style="font-size:2rem;"></i>
                    </div>
                    <div class="stat-label">Mark Today's Attendance</div>
                </div>
            </div>
            <div class="mt-2">
                <a href="{% url 'mark_attendance' %}" class="btn btn-sm btn-light fw-semibold">
                    <i class="bi bi-pencil-square me-1"></i>Enter Code
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #1a4a8e, #2980B9);">
            <div>
                <div class="stat-value"><i class="bi bi-card-checklist" style="font-size:2rem;"></i></div>
                <div class="stat-label">View All Records</div>
            </div>
            <div class="mt-2">
                <a href="{% url 'my_attendance' %}" class="btn btn-sm btn-light fw-semibold">
                    <i class="bi bi-list-check me-1"></i>My Attendance
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header-lpu d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2"></i>Recent Attendance Records</span>
        <a href="{% url 'my_attendance' %}" class="btn btn-sm btn-light">View All</a>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-lpu">
                <tr><th>Subject</th><th>Faculty</th><th>Date</th><th>Marked At</th><th>Status</th></tr>
            </thead>
            <tbody>
                {% for rec in attended %}
                <tr>
                    <td><strong>{{ rec.makeup_class.subject }}</strong></td>
                    <td>{{ rec.makeup_class.faculty.get_full_name }}</td>
                    <td>{{ rec.makeup_class.date|date:"d M Y" }}</td>
                    <td>{{ rec.marked_at|date:"d M, h:i A" }}</td>
                    <td><span class="badge bg-success">Present</span></td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-4">No attendance records yet. <a href="{% url 'mark_attendance' %}">Mark attendance now!</a></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
